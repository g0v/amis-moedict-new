<%
  if @terms.size > 1
    title params[:id]
    description @terms.first.short_description
  else
    term = @terms.first
    dictionary = term.dictionary

    title "#{params[:id]} - #{dictionary.name}"
    description term.descriptions.map(&:content).join[0..200]
  end
%>


<div class="flex items-center space-x-2">
  <h1 class="text-2xl">
    <%= params[:id] %>
    <% if @terms.first.is_stem %>
      <span class="text-base">（詞幹）</span>
    <% end %>
  </h1>
</div>
<div class="mt-4 space-y-4">
  <% @terms.each do |term| %>
    <div>
      <div class="bg-<%= term.dictionary.color %>-600 text-white p-2"><%= term.dictionary.name %></div>
      <% dictionary = term.dictionary %>
      <div>
        <span class="text-slate-400 p-0.5"><%= dictionary.dialect %></span>
        <% if term.repetition.present? %>
          <span class="bg-sky-500 text-white p-0.5">
            [疊 <%= term.repetition %>]
          </span>
        <% end %>

        <% stem = term.stem %>
        <% if stem.present? %>
          <span class="text-gray-500">
            （詞幹: <%= link_to(stem.name, term_path(stem.name)) %>）
          </span>
        <% end %>

        <% if term.audio.present? %>
          <button>
            <i class="fas fa-volume-up" onclick="document.getElementById('audio-<%= term.audio_id %>').play()"></i>
          </button>
          <%= audio_tag term.audio, id: "audio-#{term.audio_id}" %>
        <% end %>

        <button class="float-right">
          <i class="fas fa-share-alt-square text-gray-400 hover:text-gray-800 text-xl mr-2" onclick="navigator.share({url: '<%= request.base_url %>/dictionaries/<%= dictionary.id %>/terms/<%= params[:id] %>'})"></i>
        </button>
      </div>
      <% if term.descriptions.present? %>
        <ol class="list-decimal list-outside space-y-2 mt-2 ml-5">
          <% term.descriptions.each do |description| %>
            <li>
              <%= simple_format(description.content) %>
              <% if description.image.present? %>
                <p><%= image_tag description.image, alt: description.content, width: '100' %></p>
              <% end %>
              <% if description.examples.present? %>
                <ul class="list-disc list-inside space-y-1">
                  <% description.examples.each do |example| %>
                    <li>
                      <%
                        term_html = ''
                        parts = example.content.split(/[`~]/).reject(&:empty?)
                        parts.each_with_index do |part, i|
                          if part.match(/^[\p{Alnum}]+$/) && part != params[:id]
                            term_path = if i == 0
                                          "terms/#{part.downcase}"
                                        else
                                          "terms/#{part}"
                                        end
                            term_path = "dictionaries/#{@dictionary.id}/#{term_path}" if @dictionary.present?

                            term_html += "<a href=\"/#{term_path}\" class=\"border-b border-gray-300 text-gray-800 hover:bg-gray-300 focus:bg-gray-300 hover:text-[#0070a3] focus:text-[#0070a3] focus:outline focus:outline-1 focus:outline-[#69d2fc]\">#{part}</a>"
                          else
                            term_html += part
                          end
                        end
                      %>
                      <%= term_html.html_safe %>
                    </li>
                  <% end %>
                </ul>
              <% end %>

              <% if description.synonyms.alts.present? %>
                <p>
                  <span class="bg-stone-500 text-white text-sm p-0.5 ml-5 mr-2">
                    同
                  </span>
                  <% alt_array = [] %>
                  <% description.synonyms.alts.each do |synonym_alt| %>
                    <%
                      alt_html = ''
                      parts = synonym_alt.content.split(/[`~]/).reject(&:empty?)
                      parts.each_with_index do |part, i|
                        if part.match(/^[\p{Alnum}]+$/) && part != params[:id]
                          term_path = if i == 0
                                        "terms/#{part.downcase}"
                                      else
                                        "terms/#{part}"
                                      end
                          term_path = "dictionaries/#{@dictionary.id}/#{term_path}" if @dictionary.present?

                          alt_html += "<a href=\"/#{term_path}\" class=\"border-b border-gray-300 text-gray-800 hover:bg-gray-300 focus:bg-gray-300 hover:text-[#0070a3] focus:text-[#0070a3] focus:outline focus:outline-1 focus:outline-[#69d2fc]\">#{part}</a>"
                        else
                          alt_html += part
                        end
                      end

                      alt_array << alt_html
                    %>
                  <% end %>
                  <%= alt_array.join("、").html_safe %>
                </p>
              <% end %>

              <% if description.synonyms.refs.present? %>
                <p>
                  <span class="bg-stone-500 text-white text-sm p-0.5 ml-5 mr-2">
                    參見
                  </span>
                  <% ref_array = [] %>
                  <% description.synonyms.refs.each do |synonym_ref| %>
                    <%
                      ref_html = ''
                      parts = synonym_ref.content.split(/[`~]/).reject(&:empty?)
                      parts.each_with_index do |part, i|
                        if part.match(/^[\p{Alnum}]+$/) && part != params[:id]
                          term_path = if i == 0
                                        "terms/#{part.downcase}"
                                      else
                                        "terms/#{part}"
                                      end
                          term_path = "dictionaries/#{@dictionary.id}/#{term_path}" if @dictionary.present?

                          ref_html += "<a href=\"/#{term_path}\" class=\"border-b border-gray-300 text-gray-800 hover:bg-gray-300 focus:bg-gray-300 hover:text-[#0070a3] focus:text-[#0070a3] focus:outline focus:outline-1 focus:outline-[#69d2fc]\">#{part}</a>"
                        else
                          ref_html += part
                        end
                      end

                      ref_array << ref_html
                    %>
                  <% end %>
                  <%= ref_array.join("、").html_safe %>
                </p>
              <% end %>
            </li>
          <% end %>
          <!-- <li>捉獵物，獵獲的（獵物）。
            <p>O 'adopen niyam a <span class="relative group"><span class="underline">fafoy</span><span class="absolute bg-gray-200 p-1 border rounded hidden group-hover:block">fafoy<br>野豬。</span></span>。</p>
          </li> -->
        </ol>
      <% end %>
    </div>
  <% end %>
</div>
